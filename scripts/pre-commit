#!/bin/bash

# Auto-bump patch version across all version files in sync.
# Triggers on any staged source file change (excludes version-only files to avoid loops).

bump_patch() {
    local version="$1"
    local major minor patch
    IFS='.' read -r major minor patch <<< "$version"
    echo "${major}.${minor}.$((patch + 1))"
}

STAGED=$(git diff --cached --name-only)

# Skip if only version files are staged
VERSION_FILES="package.json\nsrc-tauri/tauri.conf.json\nCargo.toml"
NON_VERSION=$(echo "$STAGED" | grep -vxF -e "package.json" -e "src-tauri/tauri.conf.json" -e "Cargo.toml")

if [ -z "$NON_VERSION" ]; then
    exit 0
fi

# Read current version from tauri.conf.json (single source of truth)
current=$(grep '"version"' src-tauri/tauri.conf.json | head -1 | sed 's/.*"\([0-9]*\.[0-9]*\.[0-9]*\)".*/\1/')
new=$(bump_patch "$current")

# Update all three version files
sed -i "s/\"version\": \"$current\"/\"version\": \"$new\"/" package.json
sed -i "s/\"version\": \"$current\"/\"version\": \"$new\"/" src-tauri/tauri.conf.json
sed -i "s/^version = \"$current\"/version = \"$new\"/" Cargo.toml

git add package.json src-tauri/tauri.conf.json Cargo.toml
echo "version: $current -> $new"
